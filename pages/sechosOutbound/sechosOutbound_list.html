<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>材料出库单列表</title>
    <meta name="renderer" content="webkit" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1"
    />

    <script
      src="../../Scripts/JsAndCss.Model.js"
      type="text/javascript"
    ></script>
  </head>

  <body>
    <div id="toolBar">
      <table style="width:100%">
        <tr>
          <td>
            <form id="SearchForm">
              <table style="width:100%">
                <tr>
                  <td class="TB_01" style="width:10%">
                    出库单号:
                  </td>
                  <td class="TB_02" style="width:20%">
                    <input
                      id="purchaseOrderNumVague"
                      type="text"
                      name="purchaseOrderNumVague"
                      placeholder="请输入"
                      class="layui-input"
                    />
                  </td>
                  <td class="TB_01" style="width:10%">
                    下单日期:
                  </td>
                  <td class="TB_02" style="width:10%;">
                    <input
                      id="startTime"
                      type="text"
                      name="startTime"
                      placeholder="开始日期"
                      class="layui-input icon"
                      laydate-type="date"
                      style="width:100%;"
                    />
                  </td>
                  <td class="TB_01" style="width:2%;">
                    到
                  </td>
                  <td class="TB_02" style="width:20%;">
                    <input
                      id="endTime"
                      type="text"
                      name="endTime"
                      placeholder="结束日期"
                      class="layui-input icon"
                      laydate-type="date"
                      style="width:180px;"
                    />
                  </td>
                </tr>
                <tr>
                  <td style="padding:5px;width: 20%;">
                    <input
                      type="button"
                      value="查询"
                      onclick="search()"
                      class="layui-btn layui-btn-sm"
                    />

                    <input
                      type="button"
                      value="新增出库单"
                      onclick="addRow()"
                      class="layui-btn layui-btn-sm"
                      style="width: 30%"
                    />
                    <input
                      type="button"
                      value="删除"
                      onclick="deleteRow()"
                      class="layui-btn layui-btn-sm"
                    />
                  </td>
                </tr>
              </table>
            </form>
          </td>
        </tr>
      </table>
    </div>

    <table id="sechosPurchaseTable"></table>

    <script type="text/html" id="checkStatus">
      {{# if(d.outboundStatus == 0){ }}
      <span style="color: orange;">未填写</span>
      {{# } else if(d.outboundStatus == 1) { }}
      <span style="color: blue;">待出库</span>
      {{# } else if(d.outboundStatus == 2) { }}
      <span style="color: green;">出库中</span>
      {{# } else if(d.outboundStatus == 3) { }}
      <span style="color: red;">审批中</span>
      {{# } else if(d.outboundStatus == 4) { }}
      <span style="color: black;">已出库</span>
      {{# } }}
    </script>

    <script>
      var table;
      layui.use(["table", "laydate"], function() {
        table = layui.table;
        var $ = layui.jquery;
        search();
      });

      function initData(where) {
        var m_url =
          location.protocol +
          "\\\\" +
          location.hostname +
          ":" +
          (location.port == "" ? 80 : location.port);
        table.render({
          id: "layuiTable", //固定写法
          elem: "#sechosPurchaseTable", //固定写法
          height: "full-" + $("#toolBar").height(), //固定写法
          method: "get", //固定写法
          remoteSort: true,
          initSort: {
            field: "outboundOrderNum,orderDate",
            type: "desc,asc"
          },
          url: m_url + "/sys/sechosoutbound/listData", //数据接口
          page: true, //开启分页
          limit: 20, //每页显示行数
          where: where,
          cols: [
            [
              { type: "checkbox", fixed: "left" }, //固定
              {
                field: "outboundOrderNum",
                title: "出库单号",
                sort: true,
                minWidth: 100,
                align: "left"
              },
              {
                field: "orderDate",
                title: "下单日期",
                sort: true,
                width: 200,
                align: "center",
                templet: function(d){
                  if(d.orderDate==null){
                    return ''
                  }else{
                    return d.orderDate
                    // '<div>{{ Format(d.purchaseDate,"yyyy-MM-dd")}}</div>'
                  }
                }
              },
              {
                field: "outboundDate",
                title: "出库日期",
                sort: true,
                width: 200,
                align: "center",
                templet: function(d){
                  if(d.outboundDate==null){
                    return ''
                  }else{
                    return d.outboundDate
                  }
                }
              },
              {
                field: "outboundNote",
                title: "出库备注",
                Width: 150,
                align: "center"
              },
              {
                field: "outboundStatus",
                title: "出库状态",
                width: 100,
                align: "center",
                templet: "#checkStatus"
              },
              {
                title: "操作",
                align: "center",
                width: 80,
                fixed: "right",
                templet: function(d) {
                  if (d.outboundStatus == 0||d.outboundStatus == 1) {
                    return (
                      "<a href=\"javascript: OpenWin('/SecHosBack/pages/sechosOutbound/sechosOutbound_edit.html?rowGuid=" +
                      d.rowGuid +
                      "', 900, 600, '"+d.outboundOrderNum+"',refreshGrid)\" >填写</a>"
                    );
                  } else {
                    return (
                      "<a href=\"javascript: OpenWin('/SecHosBack/pages/sechosOutbound/sechosOutbound_detail.html?rowGuid=" +
                      d.rowGuid +
                      "', 900, 600, '"+d.outboundOrderNum+"',refreshGrid)\" >查看</a>"
                    );
                  }
                }
              }
            ]
          ]
        });
      }

      function deleteRow() {
        var rows = table.checkStatus("layuiTable").data; //获取选中行
        if (!rows || rows.length == 0) {
          top.layuiMsg("请选择要删除的记录!");
          return;
        }
        top.layuiConfirm("确定要删除该记录?", {}, function() {
          for (var i = 0; i < rows.length; i++) {
            if(rows[i].outboundStatus==2||rows[i].outboundStatus==3||rows[i].outboundStatus==4){
              top.layuiMsg("不允许删除此记录!");
              return;
            }
          }
          var RowGuids = new Array();
          for (var i = 0; i < rows.length; i++) {
            RowGuids.push(rows[i].rowGuid);
          }

          SendAjax(
            "/sys/sechosoutbound/delete",
            JSON.stringify(RowGuids),
            function(res) {
              if (res.code == "0") {
                top.messageAlert("提醒", "删除成功", "info", function() {
                  refreshGrid();
                });
              } else {
                top.messageAlert("提醒", res.msg, "error");
              }
            }
          );
          return false;
        });
      }

      function refreshGrid() {
        table.reload("layuiTable");
      }

      function search() {
        var data = $("#SearchForm").serializeJson();
        initData(data);
      }

      function addRow() {
        var personGuid = JSON.parse(localStorage.getItem('m_user_rowGuid'));
        $.ajax({
          async: true,
          url: "/sys/sechosoutbound/add/"+personGuid,
          contentType: "application/json;charset=utf-8",
          method: "post",
          dataType: "JSON",
          success: function(res) {
            if (res.code == "0") {
              top.messageAlert("提醒", "添加成功", "info", function() {
                refreshGrid();
              });
            } else {
              top.messageAlert("提醒", res.msg, "error");
            }
          }
        });
      }
    </script>
  </body>
</html>

<style>
  .layui-table-box {
    width: 100%;
  }

  .layui-table-body {
    overflow-x: hidden;
  }

  .icon {
    background-position: right;
    background-repeat: no-repeat;
    background-image: url("../../Scripts/layui/css/modules/laydate/icon.png");
  }

  .layui-btn {
    font-size: 14px;
    background-color: #3398e5;
    color: #fff;
    white-space: nowrap;
    text-align: center;
    font-size: 14px;
    border: none;
    border-radius: 2px;
    cursor: pointer;
    opacity: 0.9;
    width: 70px;
    height: 30px;
    line-height: 30px;
    padding: 0 10px;
    font-size: 13px;
    margin-left: 10px;
  }

  .layui-btn-normal {
    margin-left: 10px;
  }

  .layui-btn + .layui-btn {
    margin-left: 10px;
  }
</style>
